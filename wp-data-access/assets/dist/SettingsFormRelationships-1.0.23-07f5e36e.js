import{r as m,l as j,aB as ne,S as ie,bZ as Z,d3 as se,d4 as re,d5 as ae,j as e,B as W,c9 as S,d6 as le,n as oe,e as A,C as M}from"./main-1.0.23.js";import{a1 as ce,m as de,n as pe,l as K,M as ue,v as he,a2 as xe,k as U}from"./index.esm-1.0.23-ba0465a2.js";import{u as me,C as je,a as J,b as L}from"./ComponentColumn-1.0.23-13c86662.js";import{a as q,u as X}from"./RestApi-1.0.23-cc179eb9.js";import{h as fe,i as ge}from"./index.esm-1.0.23-da98f1a9.js";import{u as Y}from"./useFormUpdates-1.0.23-2bcf2490.js";import{a as z,F as N}from"./FormHelperText-1.0.23-83597bdf.js";import{L as O}from"./Link-1.0.23-48d9bdb4.js";import{B as d}from"./Spinner-1.0.23-90ab83ff.js";import{I as H,S as V,T as $}from"./TextField-1.0.23-1657e9d4.js";import{M as G}from"./MenuItem-1.0.23-0a5da249.js";import{T as P}from"./Tooltip-1.0.23-1b58a848.js";import{I as E}from"./iconBase-1.0.23-43ac6f06.js";import{l as be,m as _e,n as ye}from"./ActionsApp-1.0.23-18ccdb55.js";import{v as Ce}from"./FallbackSpinner-1.0.23-96931408.js";import{T as Se,a as I}from"./ToggleButtonGroup-1.0.23-fd9018f0.js";import{S as we,a as Te,b as ve}from"./Stepper-1.0.23-3d0d410f.js";import{S as Ae}from"./StepContent-1.0.23-0707671d.js";import{B as D}from"./CardContent-1.0.23-cd3f2c87.js";import{R as Re,u as ke,C as Me,g as Ne}from"./useTheme-1.0.23-55aea9bb.js";import{C as Oe}from"./ConfirmDialog-1.0.23-f318040f.js";import{P as ze}from"./PremiumFeature-1.0.23-8dd1a29b.js";import{T as Fe}from"./Typography-1.0.23-19a0fd3e.js";import"./index-1.0.23-fea3ac27.js";import{A as De,a as We}from"./AccordionSummary-1.0.23-078f8091.js";import{A as qe}from"./AccordionDetails-1.0.23-ad785ba6.js";const ee=a=>{const p=q();return m.useCallback((n,g)=>{be({app_id:n.app.app[0].app_id,cnt_id:n.app.container[0].cnt_id},h=>{const f=h==null?void 0:h.data;if(j.debug("response data",f),Array.isArray(f)){const y=ne(ie.getState(),a)??[];j.debug(y);for(let _=0;_<f.length;_++){const w=Z(f[_]);if(w!==null&&w.cnt_id_master===n.app.container[0].cnt_id){const s=y.filter(t=>t.container.cnt_id===f[_].cnt_id);if(s.length===0){const t={appId:Ce(),container:f[_]};p(se({appId:a,detail:t}))}else{const T={appId:s[0].appId,container:f[_]};p(re({appId:a,detail:T}))}}}}else j.error("error loading details",h),g!==void 0&&g()},h=>{j.error("error loading details",h),g!==void 0&&g()})},[a])},Be=a=>{const p=X(n=>ae(n,a));return j.debug("detailDisplayType",p),p},Ie=()=>{const[a,p]=m.useState(!1);return e.jsxs(z,{component:"div",children:["Only valid SQL.Â ",a?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:e.jsx(O,{sx:{cursor:"pointer"},underline:"none",onClick:()=>{p(!1)},children:"(hide examples)"})}),e.jsxs("ul",{style:{listStyle:"disc",padding:"0 40px"},children:[e.jsx("li",{children:"first_name like 'Sacha%'"}),e.jsx("li",{children:"product_id = httpPost['my_product_id'] and httpPost['my_product_id'] is not null"}),e.jsx("li",{children:"user_id = @wpda_wp_user_id"}),e.jsx("li",{children:"user_id in (select user_id from wp_usermeta where meta_key = 'wp_capabilities' and meta_value like '%coach%')"}),e.jsx("li",{children:"order_date between date_sub(now(), interval 1 week) and now()"}),e.jsx("li",{children:"status = 'send' and order_date > date_sub(now(), interval 1 week)"})]}),e.jsx("div",{children:e.jsx("strong",{children:"Advanced features:"})}),e.jsxs("ul",{style:{listStyle:"disc",padding:"0 40px",marginBottom:0},children:[e.jsxs("li",{children:["Session variable ",e.jsx("strong",{children:"@wpda_wp_user_id"})," is available to access the WordPress user ID.",e.jsx(O,{href:"https://wpdataaccess.com/docs/variable/wordpress-user-id-in-sql/",target:"_blank",style:{marginLeft:"5px",textDecoration:"none"},children:"(visit documentation page)"})]}),e.jsxs("li",{children:["The functions ",e.jsx("strong",{children:"httpGet"}),", ",e.jsx("strong",{children:"httpPost"})," and ",e.jsx("strong",{children:"httpRequest"})," can be used to access HTTP GET and POST parameters in a query. All functions return null when the requested parameter was not provided. The following condition returns no rows if no parameter was provided:",e.jsx("br",{}),e.jsx(d,{sx:{margin:"5px 20px"},children:e.jsxs("strong",{children:["where product_id = httpPost['my_product_id']",e.jsx("br",{}),"and httpPost['my_product_id'] is not null"]})}),"The condition below returns all rows if no parameter was provided:",e.jsx(d,{sx:{margin:"5px 20px"},children:e.jsxs("strong",{children:["where product_id = httpPost['my_product_id']",e.jsx("br",{}),"and httpPost['my_product_id'] is null"]})})]})]})]}):e.jsx("span",{children:e.jsx(O,{sx:{cursor:"pointer"},underline:"none",onClick:()=>{p(!0)},children:"(show examples)"})})]})},Q=({appId:a,app:p,relationship:n,metaData:g,isRelationTable:h})=>{j.debug(a,p,n,g);const f=q(),y=Y(a),[_,w]=m.useState(n.sql!==void 0&&n.sql!==""),[s,t]=m.useState(h?n.relationJoins.split(",").map(u=>{const c=u.split("=");return{masterColumn:c[0],detailColumn:c[1]??""}}):n.joins.split(",").map(u=>{const c=u.split("=");return{masterColumn:c[0],detailColumn:c[1]??""}}));j.debug("joins",s),m.useEffect(()=>{const u={...n};h?u.relationJoins=s.map(c=>c.masterColumn+"="+c.detailColumn).join(","):u.joins=s.map(c=>c.masterColumn+"="+c.detailColumn).join(","),f(W({property:"relationshipWizard",propertyValue:u})),y(!0)},[s]);const T=h?n.tbl:g.app.container[0].cnt_tbl,R=h?n.cls:g.app.container[0].cnt_cls===void 0||g.app.container[0].cnt_cls===null||g.app.container[0].cnt_cls===""?{}:JSON.parse(g.app.container[0].cnt_cls),r=h?p.appRelationTable:p.appTable,k=h?p.appRelationColumns:p.appColumns;return e.jsxs(d,{children:[...s.map((u,c)=>e.jsxs(d,{sx:{display:"grid",marginTop:"10px"},children:[e.jsxs(d,{sx:{display:"grid",gridTemplateColumns:"minmax(0, 1fr) 20px minmax(0, 1fr) auto",alignItems:"center"},children:[e.jsxs(N,{children:[e.jsx(H,{variant:"outlined",children:"master *"}),e.jsxs(V,{MenuProps:{id:"pp-select-menu"},label:"master *",value:u.masterColumn,onChange:x=>{const C=[...s];C[c].masterColumn=x.target.value,t(C),y(!0)},children:[...R.map(x=>x.isSelected?e.jsxs(G,{value:x.columnName,children:[T,".",x.columnName]}):null)]})]}),e.jsx(d,{sx:{textAlign:"center"},children:"="}),e.jsxs(N,{children:[e.jsx(H,{variant:"outlined",children:"detail *"}),e.jsxs(V,{MenuProps:{id:"pp-select-menu"},label:"detail *",value:u.detailColumn,onChange:x=>{const C=[...s];C[c].detailColumn=x.target.value,t(C),y(!0)},children:[...k.map(x=>x.isSelected?e.jsxs(G,{value:x.columnName,children:[r,".",x.columnName]}):null)]})]}),e.jsx(d,{children:c===0?e.jsx(P,{title:"Add condition",children:e.jsx(E,{color:"primary",onClick:()=>{const x=[...s];x.push({masterColumn:"",detailColumn:""}),t(x),y(!0)},children:e.jsx(fe,{})})}):e.jsx(P,{title:"Delete condition",children:e.jsx(E,{color:"primary",onClick:()=>{const x=[...s];x.splice(c,1),t(x),y(!0)},children:e.jsx(ge,{})})})})]}),e.jsx(d,{children:e.jsx(N,{children:e.jsx(z,{children:"Updating requires a table reload."})})})]})),e.jsx(d,{sx:{marginTop:"20px"},children:_?e.jsxs(N,{fullWidth:!0,children:[e.jsx($,{fullWidth:!0,label:"Optional conditions",multiline:!0,minRows:1,maxRows:10,value:h?n.relationSql:n.sql,placeholder:"Use this field to add additional conditions to show specific details only or leave blank",onChange:u=>{const c={...n};h?c.relationSql=u.target.value:c.sql=u.target.value,f(W({property:"relationshipWizard",propertyValue:c})),y(!0)}}),e.jsx(Ie,{})]}):e.jsxs(O,{onClick:()=>w(!0),sx:{textDecoration:"none",cursor:"pointer",display:"flex",alignItems:"center",gap:"5px"},children:[e.jsx(ce,{}),e.jsx("span",{children:"Add SQL conditions"})]})}),n.cardinality===S.ONE_TO_ONE&&e.jsx(d,{sx:{marginTop:"20px"},children:e.jsx(N,{fullWidth:!0,children:e.jsx(z,{children:"A join for a 1:1 relationship must return exactly one record. An error is shown when a detail query returns more than 1 record."})})})]})},Pe=({appId:a,metaData:p,isUpdating:n,initialRelationships:g,initialTitle:h,embedded:f,enableWizard:y})=>{const _=q(),w=ee(a),s=Y(a),t=me(),[T,R]=m.useState(f);j.debug("typeSelected",T);const r=X(i=>le(i));j.debug("relationship",r),m.useEffect(()=>{const i={...r};i.title=t.appTitle??"",i.dbs=t.appDatabase??"",i.tbl=t.appTable??"",i.cls=t.appColumns,i.relationTbl=t.appRelationTable??"",i.relationCls=t.appRelationColumns,_(W({property:"relationshipWizard",propertyValue:i}))},[t.appDatabase,t.appTable,t.appRelationTable,t.appColumns,t.appRelationColumns,t.appTitle]);const[k,u]=m.useState(""),c=m.useMemo(()=>r.cardinality===S.MANY_TO_MANY?["Relationship title","Select join table","Define join table join condition","Select relation table","Define relation table join condition"]:["Relationship title","Select data source","Define join condition"],[r.cardinality]),[x,C]=m.useState(0),F=i=>{switch(j.debug(i),i){case 0:if(t.appTitle===""||t.appTitle===null||h!==t.appTitle&&g.filter(l=>l.title===t.appTitle).length>0)return u("title"),!1;u("");break;case 1:if(t.appDatabase===""||t.appDatabase===null||t.appTable===""||t.appTable===null||t.appColumns.filter(l=>l.isSelected===!0).length===0)return!1;u("");break;case 2:if(r.joins==="=")return!1;u("");break;case 3:if(t.appRelationColumns.filter(l=>l.isSelected===!0).length===0)return!1;u("");break;case 4:if(r.relationJoins==="=")return!1;u("");break}return!0},v=i=>(j.debug(i),e.jsxs(d,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",justifyContent:"space-between",alignItems:"center",gap:"5px"},children:[i===0?e.jsx(d,{}):e.jsx(D,{variant:"contained",startIcon:e.jsx(de,{}),onClick:()=>{C(i-1)},children:"Previous"}),i===2&&r.cardinality!==S.MANY_TO_MANY||i===4&&r.cardinality===S.MANY_TO_MANY?e.jsx(D,{variant:"contained",startIcon:e.jsx(pe,{}),onClick:()=>{F(i)&&C(i+1)},children:"Finish"}):e.jsx(D,{variant:"contained",endIcon:e.jsx(K,{}),onClick:()=>{F(i)&&C(i+1)},children:"Next"})]}));return T?e.jsxs(e.Fragment,{children:[e.jsx(we,{activeStep:x,orientation:"vertical",sx:{marginBottom:0},children:c.map((i,l)=>e.jsxs(Te,{children:[e.jsx(ve,{children:i}),e.jsx(Ae,{children:e.jsxs(d,{sx:{display:"grid",gap:"20px",marginTop:"20px"},children:[l===0&&e.jsxs(e.Fragment,{children:[e.jsx($,{type:"text",label:"Title",error:k==="title",value:t.appTitle,fullWidth:!0,required:!0,helperText:"Container title (must be unique witin this form)",autoComplete:"off",onChange:o=>{_(oe({property:{appTitle:o.target.value}}));const b={...r};b.title=o.target.value,_(W({property:"relationshipWizard",propertyValue:b})),s(!0)}}),v(l)]}),l===1&&e.jsxs(e.Fragment,{children:[e.jsx(je,{}),e.jsx(J,{isDetail:!0}),e.jsx(L,{app:t}),v(l)]}),l===2&&e.jsxs(e.Fragment,{children:[e.jsx(Q,{appId:a,app:t,metaData:p,relationship:r}),v(l)]}),r.cardinality===S.MANY_TO_MANY&&l===3&&e.jsxs(e.Fragment,{children:[e.jsx(J,{isDetail:!0,isRelationTable:!0}),e.jsx(L,{app:t,isRelationTable:!0}),v(l)]}),r.cardinality===S.MANY_TO_MANY&&l===4&&e.jsxs(e.Fragment,{children:[e.jsx(Q,{appId:a,app:t,metaData:p,relationship:r,isRelationTable:!0}),v(l)]})]})})]},i))}),x===c.length&&e.jsxs(d,{sx:{marginTop:"20px",display:"grid",gap:"20px"},children:[e.jsx(d,{children:"Relationship wizard successfully completed. Click button below to activate."}),e.jsx(D,{fullWidth:!0,variant:"contained",onClick:()=>{const i={app_id:p.app.container[0].app_id,app_title:r.title,app_dbs:r.dbs,app_tbl:r.tbl,app_cls:r.cls},l={cnt_id_master:p.app.container[0].cnt_id,cardinality:r.cardinality,join_condition:r.joins,sql:r.sql};r.cardinality===S.MANY_TO_MANY&&(l.relation_tbl=r.relationTbl,l.relation_cls=r.relationCls,l.relation_join_condition=r.relationJoins,l.relation_sql=r.relationSql),i.app_relation=JSON.stringify(l),n?(i.app_cnt=t.appCntId,ye(i,o=>{j.debug(o),(o==null?void 0:o.code)==="ok"&&(o==null?void 0:o.message)===""?(y(!1),A("Relationship updated",{variant:"success"}),w(p,()=>{A(M.contactSupport,{variant:"error"})}),s(!1)):A(M.contactSupport,{variant:"error"})},o=>{j.error(o),A(M.contactSupport,{variant:"error"})},!1)):_e(i,o=>{j.debug(o),(o==null?void 0:o.code)==="ok"&&(o==null?void 0:o.message)===""?(y(!1),A("Relationship created",{variant:"success"}),w(p,()=>{A(M.contactSupport,{variant:"error"})}),s(!1)):A(M.contactSupport,{variant:"error"})},o=>{j.error(o),A(M.contactSupport,{variant:"error"})},!1)},children:n?"Update relationship":"Create relationship"})]})]}):e.jsx(d,{children:e.jsxs(N,{fullWidth:!0,children:[e.jsxs(Se,{fullWidth:!0,color:"primary",exclusive:!0,value:r.cardinality,onChange:(i,l)=>{if(l!==null){const o={...r};o.cardinality=l,_(W({property:"relationshipWizard",propertyValue:o}))}s(!0),R(!0)},children:[e.jsx(I,{value:S.ONE_TO_ONE,children:"1:1"}),e.jsx(I,{value:S.ONE_TO_MANY,children:"1:m"}),e.jsx(I,{value:S.MANY_TO_MANY,children:"m:m"})]}),e.jsx(z,{children:"Select cardinality."})]})})},Ee=({children:a,appId:p,embedded:n,enableWizard:g})=>{const h=Y(p),f=()=>e.jsxs(d,{children:[e.jsx(d,{sx:{paddingTop:"30px"},children:a}),e.jsx(P,{title:"Close",sx:{position:"absolute",top:0,right:"8px"},children:e.jsx(E,{onClick:()=>{g(!1),h(!1)},children:e.jsx(ue,{})})})]});return n?e.jsxs(d,{sx:{marginLeft:"-10px",marginRight:"-10px",position:"relative"},children:[e.jsx(Fe,{component:"div",sx:{height:"40px",display:"flex",alignItems:"center",marginBottom:"-10px"},children:"Relationship Wizard"}),f()]}):e.jsx(d,{children:e.jsxs("fieldset",{className:"pp-fieldset",style:{padding:"20px",position:"relative"},children:[e.jsx("legend",{children:"Relationship Wizard"}),f()]})})},xt=({appId:a,updateSettings:p})=>{var C;j.debug(a),q(),Re(),Be(a);const n=ke(a);Me(),ee(a);const[g,h]=m.useState(!1);j.debug("wizardOn",g);const[f,y]=m.useState(!1);j.debug("wizardIsUpdating",f);const[_,w]=m.useState("");j.debug("wizardTitle",_);const s=Ne(a);j.debug(s);const[t,T]=m.useState([]);j.debug(t),m.useEffect(()=>{var v,i;const F=[];if(n!==void 0&&n.length>0&&((v=s==null?void 0:s.app)==null?void 0:v.container)!==void 0&&Array.isArray((i=s==null?void 0:s.app)==null?void 0:i.container)){const l=s.app.container[0].cnt_id,o=s.app.container[0].cnt_tbl;for(let b=0;b<n.length;b++){const B=Z(n[b].container);if(B!==null&&B.cnt_id_master===l){const te=n[b].appId;F.push({appId:te,dbAppId:n[b].container.app_id,cntId:n[b].container.cnt_id,title:n[b].container.cnt_title,dbs:n[b].container.cnt_dbs,tbl:n[b].container.cnt_tbl,cls:n[b].container.cnt_cls===void 0||n[b].container.cnt_cls===null||n[b].container.cnt_cls===""?{}:JSON.parse(n[b].container.cnt_cls),relation:B,parentTbl:o})}}}T(F)},[a,(C=s==null?void 0:s.app)==null?void 0:C.container,n]),m.useState(""),m.useState(-1);const[R,r]=m.useState(!1);m.useState("");const[k,u]=m.useState(!1),[c,x]=m.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(De,{defaultExpanded:!1,disableGutters:!0,children:[e.jsx(We,{expandIcon:e.jsx(he,{}),children:"Relationships"}),e.jsxs(qe,{children:[e.jsx(d,{sx:{marginBottom:"30px"},children:g?e.jsx(e.Fragment,{children:!f&&e.jsx(Ee,{appId:a,embedded:!1,enableWizard:h,children:e.jsx(Pe,{appId:a,embedded:!1,metaData:s,isUpdating:f,enableWizard:h,initialRelationships:t,initialTitle:""})})}):e.jsx(D,{variant:"contained",fullWidth:!0,disabled:!0,startIcon:e.jsx(xe,{}),endIcon:e.jsx(K,{}),onClick:()=>{},children:"Start relationship wizard"})}),!1,e.jsx(e.Fragment,{children:!1}),e.jsxs(z,{component:"div",sx:{marginTop:"30px"},children:[e.jsxs(O,{sx:{textDecoration:"none",cursor:"pointer",display:"inline-flex","& svg":{fontSize:"1rem",marginRight:"2px"}},onClick:()=>u(!k),children:[e.jsx(U,{}),"How to use the relationship wizard?"]}),k&&e.jsxs(d,{sx:{marginTop:"20px",marginBottom:"30px",display:"grid",gap:"20px"},children:[e.jsx(d,{children:"The following relationship types are supported:"}),e.jsxs("ul",{style:{listStyle:"disc",padding:"0 40px"},children:[e.jsx("li",{children:"one to one relationship (1:1)"}),e.jsx("li",{children:"one to many relationship (1:m)"}),e.jsx("li",{children:"many to many relationship (m:m)"})]}),e.jsxs(d,{children:["To add a relationship, click the ",e.jsx("strong",{children:"start relationship wizard"})," button and follow the instructions. Relationships are added to the bottom of the form. Use the display type to define how relationships are displayed (possible values are: ",e.jsx("strong",{children:"Accordion"}),", ",e.jsx("strong",{children:"Tabs"})," or ",e.jsx("strong",{children:"Titles"}),")."]})]})]}),e.jsxs(z,{component:"div",children:[e.jsxs(O,{sx:{textDecoration:"none",cursor:"pointer",display:"inline-flex","& svg":{fontSize:"1rem",marginRight:"2px"}},onClick:()=>x(!c),children:[e.jsx(U,{}),"How to create a multi level master detail form?"]}),c&&e.jsx(d,{sx:{marginTop:"20px",display:"grid",gap:"20px"},children:e.jsxs(d,{children:["Add a ",e.jsx("strong",{children:"relationship"})," to the ",e.jsx("strong",{children:"master table"})," using the ",e.jsx("strong",{children:"relationship wizard"}),". Open the ",e.jsx("strong",{children:"detail table"}),". Open the ",e.jsx("strong",{children:"Table Builder"})," from the ",e.jsx("strong",{children:"detail table"})," or navigate to the ",e.jsx("strong",{children:"detail form"})," to open the ",e.jsx("strong",{children:"Form Builder"}),". The buttons to access the ",e.jsx("strong",{children:"Table Builders"})," and ",e.jsx("strong",{children:"Form Builders"})," are available in the footer. Open the ",e.jsx("strong",{children:"Relationships"})," section and start the ",e.jsx("strong",{children:"relationship wizard"}),"."]})})]}),e.jsx(ze,{})]})]}),R&&e.jsx(Oe,{title:"Delete Relationship?",message:"Are you sure you want to delete this relationship? This action cannot be undone!",open:R,setOpen:r,onConfirm:()=>{}})]})};export{Ie as D,xt as S,ee as U};
