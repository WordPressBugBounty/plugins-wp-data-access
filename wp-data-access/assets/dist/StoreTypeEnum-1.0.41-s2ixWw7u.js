import{l as t,ah as ve,E as he,A as F,a7 as b,r as Y,ai as q,aj as Se,ak as Ne,al as _e,b as Ae,a6 as k,am as G,a8 as Pe,a9 as Ce,an as Je,F as xe,g as Te,ao as De,S as we,ap as Fe,aq as Ie,ar as Re,as as Ue,at as Ee,aa as Be}from"./lib-1.0.41-DFdWuh_n.js";import{a as Me}from"./hooks-1.0.41-sDnKeMy7.js";const Ve=(c,I)=>({app_id:c,cnt_id:I}),je=(c,I)=>({dbs:c,tbl:I}),Ge=(c,I)=>{t.debug(c,I);const T=Me(),Oe=(i,u,e,_)=>{var o,A,D,a,N,O,y,R,d,j,U,E,B,M,s,n,h,W,z,H,K,Q,X,Z,$,ee,le,se,te,re,ne,ue,oe,me,ce,ie,pe,be,ge,fe,ae;t.debug(e);const S=(o=e.access.insert)==null?void 0:o.some(r=>r.toUpperCase()==="POST"),v=(A=e.access.update)==null?void 0:A.some(r=>r.toUpperCase()==="POST"),g=(D=e.access.delete)==null?void 0:D.some(r=>r.toUpperCase()==="POST");e.src=je(i,u),e.privs={select:!0,insert:S,update:v,delete:g};let l={};((O=(N=(a=e==null?void 0:e.settings)==null?void 0:a.ui)==null?void 0:N.global)==null?void 0:O.table)!==!1?(l=b({},Y,(d=(R=(y=e==null?void 0:e.settings)==null?void 0:y.ui)==null?void 0:R.global)==null?void 0:d.table),(s=(M=(B=(E=(U=(j=e==null?void 0:e.settings)==null?void 0:j.ui)==null?void 0:U.global)==null?void 0:E.table)==null?void 0:B.table)==null?void 0:M.pagination)!=null&&s.rowsPerPage&&(l.table.pagination.rowsPerPage=[...e.settings.ui.global.table.table.pagination.rowsPerPage]),(H=(z=(W=(h=(n=e==null?void 0:e.settings)==null?void 0:n.ui)==null?void 0:h.global)==null?void 0:W.table)==null?void 0:z.table)!=null&&H.defaultOrderBy&&(l.table.defaultOrderBy=[...e.settings.ui.global.table.table.defaultOrderBy])):l=b({},Y,{table:{transactions:{insert:S,update:v,delete:g},bulkActions:{pdf:!1,csv:!0,json:!0,excel:!1,xml:!0,sql:!0,delete:(K=e==null?void 0:e.privs)==null?void 0:K.delete}}});const w=[];for(let r=0;r<e.columns.length;r++)w[r]=q(e.columns[r].column_name,e.table_labels[e.columns[r].column_name]??e.columns[r].column_name);const f=[];if(Array.isArray(l.columns)&&l.columns.length>0){for(let r=0;r<l.columns.length;r++){const V=Te(e,l.columns[r].columnName);V!==void 0?f.push(b({},w[V],l.columns[r])):f.push(b({},q(e.columns[r].column_name),l.columns[r]))}l.columns=f}else l.columns=w;l.table.largeTableSupport.saved===Ne.AUTO?l.table.largeTableSupport.actual=_e(e):l.table.largeTableSupport.actual=l.table.largeTableSupport.saved,t.debug(l);let m={...k};((Z=(X=(Q=e==null?void 0:e.settings)==null?void 0:Q.ui)==null?void 0:X.global)==null?void 0:Z.form)!==!1&&(m=b({},k,(le=(ee=($=e==null?void 0:e.settings)==null?void 0:$.ui)==null?void 0:ee.global)==null?void 0:le.form));const P=[];for(let r=0;r<e.columns.length;r++)P[r]=G(e.columns[r].column_name,e.form_labels[e.columns[r].column_name]??e.columns[r].column_name);const C=[];if(Array.isArray(m.columns)&&m.columns.length>0){for(let r=0;r<m.columns.length;r++){const V=Te(e,m.columns[r].columnName);V!==void 0?C.push(b({},P[V],m.columns[r])):C.push(b({},G(m.columns[r].column_name),m.columns[r]))}m.columns=C}else m.columns=P;const J=De.getSelectors().selectSelected(we.getState().explorer);t.debug("selected",J),J&&J[i]==="wp"&&((te=(se=e==null?void 0:e.settings)==null?void 0:se.wp)==null?void 0:te.tables)!==void 0&&Array.isArray(e.settings.wp.tables)&&e.settings.wp.tables.includes(u)&&(m.form={...Fe},m.form.preserveSpacesOnUpdate=!0);let x={};if(((ue=(ne=(re=e==null?void 0:e.settings)==null?void 0:re.ui)==null?void 0:ne.global)==null?void 0:ue.theme)!==void 0&&((ce=(me=(oe=e==null?void 0:e.settings)==null?void 0:oe.ui)==null?void 0:me.global)==null?void 0:ce.theme)!==null&&((be=(pe=(ie=e==null?void 0:e.settings)==null?void 0:ie.ui)==null?void 0:pe.global)==null?void 0:be.theme)!=="")try{x=JSON.parse((ae=(fe=(ge=e==null?void 0:e.settings)==null?void 0:ge.ui)==null?void 0:fe.global)==null?void 0:ae.theme)}catch(r){t.error("Invalid JSON - theme settings"),t.error(r)}x===!1&&(x={});const p=b({},Ie,x);return L(e,l,m,p,_===!0)},ye=(i,u,e,_,S,v)=>{var U,E,B,M;t.debug(i,u,e,_,S);const g=u.app.app[0];t.debug(g);const l=u.app.container[0];t.debug(l);let w={};try{w=JSON.parse(g.app_settings)}catch(s){t.error("Invalid JSON - app settings"),t.error(s)}t.debug(w);let f={};try{f=JSON.parse(l.cnt_cls)}catch(s){t.error("Invalid JSON - app columns"),t.error(s)}t.debug(f);const m=g.app_type,P=Number(m)===F.DATAENTRY||Number(m)===F.REGISTRATION,C=Number(m)===F.DATAENTRY||Number(m)===F.REGISTRATION||Number(m)===F.UPDATEFORM,J=Number(m)===F.DATAENTRY;t.debug(P,C,J),u.src=Ve(i,l.cnt_id),u.privs={select:!0,insert:P,update:C,delete:J};const x=b({},Y,{table:{transactions:{insert:P,update:C,delete:J},bulkActions:{pdf:!1,csv:!0,json:!0,excel:!1,xml:!0,sql:!0,delete:(U=u==null?void 0:u.privs)==null?void 0:U.delete}}});t.debug(x);let p={};if(l.cnt_table!==void 0&&l.cnt_table!==null&&l.cnt_table!=="")try{p=JSON.parse(l.cnt_table)}catch(s){t.error("Invalid JSON - table settings"),t.error(s)}t.debug(p);const o=b({},x,p);(B=(E=p==null?void 0:p.table)==null?void 0:E.pagination)!=null&&B.rowsPerPage&&(o.table.pagination.rowsPerPage=[...p.table.pagination.rowsPerPage]),(M=p==null?void 0:p.table)!=null&&M.defaultOrderBy&&(o.table.defaultOrderBy=[...p.table.defaultOrderBy]),t.debug(o);const A=[];for(let s=0;s<f.length;s++)f[s].isSelected===!0&&A.push(q(f[s].columnName,u.table_labels[f[s].columnName]??f[s].columnName,!0));if(t.debug(A),Array.isArray(o.columns)&&o.columns.length>0){const s=[];for(let n=0;n<o.columns.length;n++)if(o.columns[n].computedField!==void 0)s.push(b({},q(o.columns[n].columnName),o.columns[n]));else{const h=Se(A,o.columns[n].columnName);h!==void 0&&s.push(b({},A[h],o.columns[n]))}A.map(n=>{s.filter(h=>h.columnName===n.columnName).length===0&&s.push(n)}),t.debug(s),o.columns=s}else o.columns=A;if(o.table.largeTableSupport.saved===Ne.AUTO?o.table.largeTableSupport.actual=_e(u):o.table.largeTableSupport.actual=o.table.largeTableSupport.saved,(u==null?void 0:u.isRelationSelectionTable)===!0&&(p==null?void 0:p.columns)!==void 0&&Array.isArray(p.columns)){const s=[];p.columns.map(n=>{if(n.columnName.startsWith(Ae.relationTablePrefix)){const h={...n};h.columnName=n.columnName.substring(Ae.relationTablePrefix.length),s.push(h)}}),o.columns=[...s]}t.debug(o);let D={};if((l==null?void 0:l.cnt_form)!==void 0&&(l==null?void 0:l.cnt_form)!==null&&(l==null?void 0:l.cnt_form)!==""||u.useRform===!0&&(l==null?void 0:l.cnt_rform)!==void 0&&(l==null?void 0:l.cnt_rform)!==null&&(l==null?void 0:l.cnt_rform)!=="")try{u.useRform===!0?D=JSON.parse(l.cnt_rform):D=JSON.parse(l.cnt_form)}catch(s){t.error("Invalid JSON - form settings"),t.error(s)}t.debug(D);const a=b({},k,D);t.debug(a);const N=[];for(let s=0;s<f.length;s++)f[s].isSelected===!0&&N.push(G(f[s].columnName,u.form_labels[f[s].columnName]??f[s].columnName,!0));if(t.debug(N),Array.isArray(a.columns)&&a.columns.length>0){const s=[];for(let n=0;n<a.columns.length;n++)if(a.columns[n].computedField!==void 0)s.push(b({},N[n],a.columns[n]));else{const h=Se(N,a.columns[n].columnName);h!==void 0&&s.push(b({},N[h],a.columns[n]))}N.map(n=>{s.filter(h=>h.columnName===n.columnName).length===0&&s.push(n)}),a.columns=s}else a.columns=N;t.debug(a);let O={};if((g==null?void 0:g.app_theme)!==void 0&&(g==null?void 0:g.app_theme)!==null&&(g==null?void 0:g.app_theme)!=="")try{O=JSON.parse(g.app_theme)}catch(s){t.error("Invalid JSON - theme settings"),t.error(s)}O===!1&&(O={}),t.debug(O),S!==void 0&&(u.appRootId=S);let y={};if((l==null?void 0:l.cnt_chart)!==void 0&&(l==null?void 0:l.cnt_chart)!==null&&(l==null?void 0:l.cnt_chart)!=="")try{y=JSON.parse(l.cnt_chart)}catch(s){t.error("Invalid JSON - chart settings"),t.error(s)}y===!1&&(y={}),t.debug(y);const R=b({},Pe,y);t.debug(R),T(Ce({appId:c,chartState:R}));let d={};if((l==null?void 0:l.cnt_map)!==void 0&&(l==null?void 0:l.cnt_map)!==null&&(l==null?void 0:l.cnt_map)!=="")try{d=JSON.parse(l.cnt_map)}catch(s){t.error("Invalid JSON - chart settings"),t.error(s)}d===!1&&(d={}),t.debug(d);const j=b({},Je,d);return T(xe({appId:c,mapState:j})),L(u,o,a,O,e===!0,v)},de=(i,u)=>{t.debug(i);const e=i.app.app[0];t.debug(e);let _={};try{_=JSON.parse(e.app_settings)}catch(S){t.error("Invalid JSON - app settings"),t.error(S)}return t.debug(_),T(ve({appId:c,apps:i.app.apps,titles:i.app.titles,appSettings:_})),T(he({appId:c,metaData:{...i,isExploring:u??!1}})),!0},L=(i,u,e,_,S,v)=>(t.debug(i),T(he({appId:c,metaData:{...i}})),T(Re({appId:c,tableState:u,tableAccess:{insert:i.privs.insert,update:i.privs.update,delete:i.privs.delete},isView:Ue(i),exploring:S})),T(Ee({appId:c,formState:e})),T(Be({appId:c,themeState:_})),v!==void 0&&v(),!0);return{prepareAdminStore:Oe,prepareAppStore:ye,prepareApp:de}};var qe=(c=>(c[c.ADMIN=0]="ADMIN",c[c.APP=1]="APP",c))(qe||{});export{Ve as D,qe as S,Ge as u};
