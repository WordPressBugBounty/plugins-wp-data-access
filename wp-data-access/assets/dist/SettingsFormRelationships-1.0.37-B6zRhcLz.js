import{j as e}from"./cm-1.0.37-CEr77VZi.js";import{r as m}from"./redux-1.0.37-C4JSQ-MG.js";import{ae as le,n as de,o as ce,m as ee,M as pe,w as ue,af as he,l as V}from"./index-1.0.37-B60ShF2d.js";import{u as xe,C as me,a as G,b as Q}from"./ComponentColumn-1.0.37-dxZBqVrm.js";import{a as I,u as te}from"./hooks-1.0.37-DW0_oiBB.js";import{l as j,b4 as je,S as fe,bw as ne,v as ge,c7 as be,c8 as _e,w as O,bF as S,m as ye,b as k}from"./lib-1.0.37-Czwr-8r3.js";import{p as we,q as Ce}from"./index-1.0.37-CK0QxOhD.js";import{u as U}from"./useFormUpdater-1.0.37-BEcFxYga.js";import{a as N,F as M}from"./FormHelperText-1.0.37-ylnS0Km6.js";import{L as A}from"./Link-1.0.37-B0loYHQn.js";import{B as l}from"./Spinner-1.0.37-CwhfSVqI.js";import{I as K,T as se}from"./TextField-1.0.37-CCe4G0U1.js";import{S as X}from"./Select-1.0.37-B5ZKqjeL.js";import{M as Z}from"./MenuItem-1.0.37-JkRcsicb.js";import{T as B}from"./Tooltip-1.0.37-BLWvlO4a.js";import{I as Y}from"./iconBase-1.0.37-DRohixw7.js";import{l as Se,m as Te,n as ve}from"./useLoadAppMetaData-1.0.37-_NoyHHQ3.js";import{e as v}from"./notistack-1.0.37-CEqipxDI.js";import{T as Ae,a as E}from"./ToggleButtonGroup-1.0.37-BCHx2oZO.js";import{S as Re,a as ke,b as Me}from"./Stepper-1.0.37-0J4mX0Mf.js";import{S as Ne}from"./StepContent-1.0.37-IQckXEeD.js";import{B as F,C as ze}from"./ConfirmDialog-1.0.37-BDQ_OfRf.js";import{u as Fe}from"./AppTheme-1.0.37-DOXnENpA.js";import{u as Oe,C as De}from"./useFormDetails-1.0.37-DnrKW97d.js";import{u as We}from"./useRemoveAppFromStore-1.0.37-HphIv4xo.js";import{P as Ie}from"./PremiumFeature-1.0.37-BKt66-Fr.js";import{T as qe}from"./Typography-1.0.37-DjtXWQnP.js";import{A as Pe,a as Ee}from"./AccordionSummary-1.0.37-Dp-yE6bD.js";import{A as Be}from"./AccordionDetails-1.0.37-CWpLs4PS.js";const re=i=>{const d=I();return m.useCallback((n,x)=>{Se({app_id:n.app.app[0].app_id,cnt_id:n.app.container[0].cnt_id},p=>{var g;const f=p==null?void 0:p.data;if(j.debug("response data",f),Array.isArray(f)){const w=((g=je.getSelectors().selectFormState(fe.getState().forms,i))==null?void 0:g.details)??[];j.debug(w);for(let y=0;y<f.length;y++){const t=ne(f[y]);if(t!==null&&t.cnt_id_master===n.app.container[0].cnt_id){const s=w.filter(b=>b.container.cnt_id===f[y].cnt_id);if(s.length===0){const b={appId:ge(),container:f[y]};d(be({appId:i,detail:b}))}else{const R={appId:s[0].appId,container:f[y]};d(_e({appId:i,detail:R}))}}}}else j.error("error loading details",p),x!==void 0&&x()},p=>{j.error("error loading details",p),x!==void 0&&x()})},[i])},Ye=i=>{const d=te(n=>{var x,p;return(p=(x=n.forms[i])==null?void 0:x.form)==null?void 0:p.detailDisplayType});return j.debug("detailDisplayType",d),d},Ue=()=>{const[i,d]=m.useState(!1);return e.jsxs(N,{component:"div",children:["Only valid SQL.Â ",i?e.jsxs(e.Fragment,{children:[e.jsx("span",{children:e.jsx(A,{sx:{cursor:"pointer"},underline:"none",onClick:()=>{d(!1)},children:"(hide examples)"})}),e.jsxs("ul",{style:{listStyle:"disc",padding:"0 40px"},children:[e.jsx("li",{children:"where first_name like 'Sacha%'"}),e.jsx("li",{children:"where product_id = httpPost['my_product_id'] and httpPost['my_product_id'] is not null"}),e.jsx("li",{children:"where user_id = @wpda_wp_user_id"}),e.jsx("li",{children:"where user_id in (select user_id from wp_usermeta where meta_key = 'wp_capabilities' and meta_value like '%coach%')"}),e.jsx("li",{children:"where order_date between date_sub(now(), interval 1 week) and now()"}),e.jsx("li",{children:"where status = 'send' and order_date > date_sub(now(), interval 1 week)"})]}),e.jsx("div",{children:e.jsx("strong",{children:"Advanced features:"})}),e.jsxs("ul",{style:{listStyle:"disc",padding:"0 40px",marginBottom:0},children:[e.jsxs("li",{children:["Session variable ",e.jsx("strong",{children:"@wpda_wp_user_id"})," is available to access the WordPress user ID.",e.jsx(A,{href:"https://wpdataaccess.com/docs/tool-guide/wordpress-user-id-in-sql/",target:"_blank",style:{marginLeft:"5px",textDecoration:"none"},children:"(read more...)"})]}),e.jsxs("li",{children:["The functions ",e.jsx("strong",{children:"httpGet"}),", ",e.jsx("strong",{children:"httpPost"})," and ",e.jsx("strong",{children:"httpRequest"})," can be used to access HTTP GET and POST parameters. All functions return null when the requested parameter was not provided.",e.jsx(A,{href:"https://wpdataaccess.com/docs/table-builder-filters/code-url-parameters/",target:"_blank",style:{marginLeft:"5px",textDecoration:"none"},children:"(read more...)"}),e.jsx("br",{}),"The following condition returns no rows if no parameter was provided:",e.jsx("br",{}),e.jsx(l,{sx:{margin:"5px 20px"},children:e.jsxs("strong",{children:["where product_id = httpPost['my_product_id']",e.jsx("br",{}),"and httpPost['my_product_id'] is not null"]})}),"The condition below returns all rows if no parameter was provided:",e.jsx(l,{sx:{margin:"5px 20px"},children:e.jsxs("strong",{children:["where product_id = httpPost['my_product_id']",e.jsx("br",{}),"or httpPost['my_product_id'] is null"]})})]}),e.jsxs("li",{children:["The function ",e.jsx("strong",{children:"shortcodeParam"})," can be used to access shortcode parameters. The function return null when the requested parameter was not provided.",e.jsx(A,{href:"https://wpdataaccess.com/docs/table-builder-filters/shortcode-parameters/",target:"_blank",style:{marginLeft:"5px",textDecoration:"none"},children:"(read more...)"}),e.jsx("br",{}),"Example using shortcode parameter student_id:",e.jsx(l,{sx:{margin:"5px 20px"},children:e.jsx("strong",{children:"where student_id = shortcodeParam['student_id']"})})]})]})]}):e.jsx("span",{children:e.jsx(A,{sx:{cursor:"pointer"},underline:"none",onClick:()=>{d(!0)},children:"(show examples)"})})]})},$=({appId:i,app:d,relationship:n,metaData:x,isRelationTable:p})=>{j.debug(i,d,n,x);const f=I(),g=U(i),[w,y]=m.useState(n.sql!==void 0&&n.sql!==""),[t,s]=m.useState(p?n.relationJoins.split(",").map(u=>{const c=u.split("=");return{masterColumn:c[0],detailColumn:c[1]??""}}):n.joins.split(",").map(u=>{const c=u.split("=");return{masterColumn:c[0],detailColumn:c[1]??""}}));j.debug("joins",t),m.useEffect(()=>{const u={...n};p?u.relationJoins=t.map(c=>c.masterColumn+"="+c.detailColumn).join(","):u.joins=t.map(c=>c.masterColumn+"="+c.detailColumn).join(","),f(O({property:"relationshipWizard",propertyValue:u})),g(!0)},[t]);const b=p?n.tbl:x.app.container[0].cnt_tbl,R=p?n.cls:x.app.container[0].cnt_cls===void 0||x.app.container[0].cnt_cls===null||x.app.container[0].cnt_cls===""?{}:JSON.parse(x.app.container[0].cnt_cls),D=p?d.appRelationTable:d.appTable,W=p?d.appRelationColumns:d.appColumns;return e.jsxs(l,{children:[...t.map((u,c)=>e.jsxs(l,{sx:{display:"grid",marginTop:"10px"},children:[e.jsxs(l,{sx:{display:"grid",gridTemplateColumns:"minmax(0, 1fr) 20px minmax(0, 1fr) auto",alignItems:"center"},children:[e.jsxs(M,{children:[e.jsx(K,{variant:"outlined",children:"master *"}),e.jsxs(X,{MenuProps:{id:"pp-select-menu"},label:"master *",value:u.masterColumn,onChange:h=>{const C=[...t];C[c].masterColumn=h.target.value,s(C),g(!0)},children:[...R.map(h=>h.isSelected?e.jsxs(Z,{value:h.columnName,children:[b,".",h.columnName]}):null)]})]}),e.jsx(l,{sx:{textAlign:"center"},children:"="}),e.jsxs(M,{children:[e.jsx(K,{variant:"outlined",children:"detail *"}),e.jsxs(X,{MenuProps:{id:"pp-select-menu"},label:"detail *",value:u.detailColumn,onChange:h=>{const C=[...t];C[c].detailColumn=h.target.value,s(C),g(!0)},children:[...W.map(h=>h.isSelected?e.jsxs(Z,{value:h.columnName,children:[D,".",h.columnName]}):null)]})]}),e.jsx(l,{children:c===0?e.jsx(B,{title:"Add condition",children:e.jsx(Y,{color:"primary",onClick:()=>{const h=[...t];h.push({masterColumn:"",detailColumn:""}),s(h),g(!0)},children:e.jsx(we,{})})}):e.jsx(B,{title:"Delete condition",children:e.jsx(Y,{color:"primary",onClick:()=>{const h=[...t];h.splice(c,1),s(h),g(!0)},children:e.jsx(Ce,{})})})})]}),e.jsx(l,{children:e.jsx(M,{children:e.jsx(N,{children:"Updating requires a table reload."})})})]})),e.jsx(l,{sx:{marginTop:"20px"},children:w?e.jsxs(M,{fullWidth:!0,children:[e.jsx(se,{fullWidth:!0,label:"Optional conditions",multiline:!0,minRows:1,maxRows:10,value:p?n.relationSql:n.sql,placeholder:"Use this field to add additional conditions to show specific details only or leave blank",onChange:u=>{const c={...n};p?c.relationSql=u.target.value:c.sql=u.target.value,f(O({property:"relationshipWizard",propertyValue:c})),g(!0)}}),e.jsx(Ue,{})]}):e.jsxs(A,{onClick:()=>y(!0),sx:{textDecoration:"none",cursor:"pointer",display:"flex",alignItems:"center",gap:"5px"},children:[e.jsx(le,{}),e.jsx("span",{children:"Add SQL conditions"})]})}),n.cardinality===S.ONE_TO_ONE&&e.jsx(l,{sx:{marginTop:"20px"},children:e.jsx(M,{fullWidth:!0,children:e.jsx(N,{children:"A join for a 1:1 relationship must return exactly one record. An error is shown when a detail query returns more than 1 record."})})})]})},Je=()=>{const i=te(d=>d.apps.relationshipWizard);return j.debug("relationship",i),i},Le=({appId:i,metaData:d,isUpdating:n,initialRelationships:x,initialTitle:p,embedded:f,enableWizard:g})=>{const w=I(),y=re(i),t=xe(),s=Je(),b=U(i),[R,D]=m.useState(f);j.debug("typeSelected",R),m.useEffect(()=>{const r={...s};r.title=t.appTitle??"",r.dbs=t.appDatabase??"",r.tbl=t.appTable??"",r.cls=t.appColumns,r.relationTbl=t.appRelationTable??"",r.relationCls=t.appRelationColumns,w(O({property:"relationshipWizard",propertyValue:r}))},[t.appDatabase,t.appTable,t.appRelationTable,t.appColumns,t.appRelationColumns,t.appTitle]);const[W,u]=m.useState(""),c=m.useMemo(()=>s.cardinality===S.MANY_TO_MANY?["Relationship title","Select join table","Define join table join condition","Select relation table","Define relation table join condition"]:["Relationship title","Select data source","Define join condition"],[s.cardinality]),[h,C]=m.useState(0),q=r=>{switch(j.debug(r),r){case 0:if(t.appTitle===""||t.appTitle===null||p!==t.appTitle&&x.filter(a=>a.title===t.appTitle).length>0)return u("title"),!1;u("");break;case 1:if(t.appDatabase===""||t.appDatabase===null||t.appTable===""||t.appTable===null||t.appColumns.filter(a=>a.isSelected===!0).length===0)return!1;u("");break;case 2:if(s.joins==="=")return!1;u("");break;case 3:if(t.appRelationColumns.filter(a=>a.isSelected===!0).length===0)return!1;u("");break;case 4:if(s.relationJoins==="=")return!1;u("");break}return!0},T=r=>(j.debug(r),e.jsxs(l,{sx:{display:"grid",gridTemplateColumns:"1fr 1fr",justifyContent:"space-between",alignItems:"center",gap:"5px"},children:[r===0?e.jsx(l,{}):e.jsx(F,{variant:"contained",startIcon:e.jsx(de,{}),onClick:()=>{C(r-1)},children:"Previous"}),r===2&&s.cardinality!==S.MANY_TO_MANY||r===4&&s.cardinality===S.MANY_TO_MANY?e.jsx(F,{variant:"contained",startIcon:e.jsx(ce,{}),onClick:()=>{q(r)&&C(r+1)},children:"Finish"}):e.jsx(F,{variant:"contained",endIcon:e.jsx(ee,{}),onClick:()=>{q(r)&&C(r+1)},children:"Next"})]}));return R?e.jsxs(e.Fragment,{children:[e.jsx(Re,{activeStep:h,orientation:"vertical",sx:{marginBottom:0},children:c.map((r,a)=>e.jsxs(ke,{children:[e.jsx(Me,{children:r}),e.jsx(Ne,{children:e.jsxs(l,{sx:{display:"grid",gap:"20px",marginTop:"20px"},children:[a===0&&e.jsxs(e.Fragment,{children:[e.jsx(se,{type:"text",label:"Title",error:W==="title",value:t.appTitle,fullWidth:!0,required:!0,helperText:"Container title (must be unique witin this form)",autoComplete:"off",onChange:o=>{w(ye({property:{appTitle:o.target.value}}));const z={...s};z.title=o.target.value,w(O({property:"relationshipWizard",propertyValue:z})),b(!0)}}),T(a)]}),a===1&&e.jsxs(e.Fragment,{children:[e.jsx(me,{}),e.jsx(G,{isDetail:!0}),e.jsx(Q,{app:t}),T(a)]}),a===2&&e.jsxs(e.Fragment,{children:[e.jsx($,{appId:i,app:t,metaData:d,relationship:s}),T(a)]}),s.cardinality===S.MANY_TO_MANY&&a===3&&e.jsxs(e.Fragment,{children:[e.jsx(G,{isDetail:!0,isRelationTable:!0}),e.jsx(Q,{app:t,isRelationTable:!0}),T(a)]}),s.cardinality===S.MANY_TO_MANY&&a===4&&e.jsxs(e.Fragment,{children:[e.jsx($,{appId:i,app:t,metaData:d,relationship:s,isRelationTable:!0}),T(a)]})]})})]},r))}),h===c.length&&e.jsxs(l,{sx:{marginTop:"20px",display:"grid",gap:"20px"},children:[e.jsx(l,{children:"Relationship wizard successfully completed. Click button below to activate."}),e.jsx(F,{fullWidth:!0,variant:"contained",onClick:()=>{const r={app_id:d.app.container[0].app_id,app_title:s.title,app_dbs:s.dbs,app_tbl:s.tbl,app_cls:s.cls},a={cnt_id_master:d.app.container[0].cnt_id,cardinality:s.cardinality,join_condition:s.joins,sql:s.sql};s.cardinality===S.MANY_TO_MANY&&(a.relation_tbl=s.relationTbl,a.relation_cls=s.relationCls,a.relation_join_condition=s.relationJoins,a.relation_sql=s.relationSql),r.app_relation=JSON.stringify(a),n?(r.app_cnt=t.appCntId,ve(r,o=>{j.debug(o),(o==null?void 0:o.code)==="ok"&&(o==null?void 0:o.message)===""?(g(!1),v("Relationship updated",{variant:"success"}),y(d,()=>{v(k.contactSupport,{variant:"error"})}),b(!1)):v(k.contactSupport,{variant:"error"})},o=>{j.error(o),v(k.contactSupport,{variant:"error"})},!1)):Te(r,o=>{j.debug(o),(o==null?void 0:o.code)==="ok"&&(o==null?void 0:o.message)===""?(g(!1),v("Relationship created",{variant:"success"}),y(d,()=>{v(k.contactSupport,{variant:"error"})}),b(!1)):v(k.contactSupport,{variant:"error"})},o=>{j.error(o),v(k.contactSupport,{variant:"error"})},!1)},children:n?"Update relationship":"Create relationship"})]})]}):e.jsx(l,{children:e.jsxs(M,{fullWidth:!0,children:[e.jsxs(Ae,{fullWidth:!0,color:"primary",exclusive:!0,value:s.cardinality,onChange:(r,a)=>{if(a!==null){const o={...s};o.cardinality=a,w(O({property:"relationshipWizard",propertyValue:o}))}b(!0),D(!0)},children:[e.jsx(E,{value:S.ONE_TO_ONE,children:"1:1"}),e.jsx(E,{value:S.ONE_TO_MANY,children:"1:m"}),e.jsx(E,{value:S.MANY_TO_MANY,children:"m:m"})]}),e.jsx(N,{children:"Select cardinality."})]})})},He=({children:i,appId:d,embedded:n,enableWizard:x})=>{const p=U(d),f=()=>e.jsxs(l,{children:[e.jsx(l,{sx:{paddingTop:"30px"},children:i}),e.jsx(B,{title:"Close",sx:{position:"absolute",top:0,right:"8px"},children:e.jsx(Y,{onClick:()=>{x(!1),p(!1)},children:e.jsx(pe,{})})})]});return n?e.jsxs(l,{sx:{marginLeft:"-10px",marginRight:"-10px",position:"relative"},children:[e.jsx(qe,{component:"div",sx:{height:"40px",display:"flex",alignItems:"center",marginBottom:"-10px"},children:"Relationship Wizard"}),f()]}):e.jsx(l,{children:e.jsxs("fieldset",{className:"pp-fieldset",style:{position:"relative"},children:[e.jsx("legend",{children:"Relationship Wizard"}),f()]})})},wt=({appId:i,updateSettings:d})=>{var z;j.debug(i),I(),We(),Ye(i);const n=Oe(i);De(),re(i);const[x,p]=m.useState(!1);j.debug("wizardOn",x);const[f,g]=m.useState(!1);j.debug("wizardIsUpdating",f);const[w,y]=m.useState("");j.debug("wizardTitle",w);const t=Fe(i);j.debug(t);const[s,b]=m.useState([]);j.debug(s),m.useEffect(()=>{var L,H;const J=[];if(n!==void 0&&n.length>0&&((L=t==null?void 0:t.app)==null?void 0:L.container)!==void 0&&Array.isArray((H=t==null?void 0:t.app)==null?void 0:H.container)){const ie=t.app.container[0].cnt_id,ae=t.app.container[0].cnt_tbl;for(let _=0;_<n.length;_++){const P=ne(n[_].container);if(P!==null&&P.cnt_id_master===ie){const oe=n[_].appId;J.push({appId:oe,dbAppId:n[_].container.app_id,cntId:n[_].container.cnt_id,title:n[_].container.cnt_title,dbs:n[_].container.cnt_dbs,tbl:n[_].container.cnt_tbl,cls:n[_].container.cnt_cls===void 0||n[_].container.cnt_cls===null||n[_].container.cnt_cls===""?{}:JSON.parse(n[_].container.cnt_cls),relation:P,parentTbl:ae})}}}b(J)},[i,(z=t==null?void 0:t.app)==null?void 0:z.container,n]);const[R,D]=m.useState(""),[W,u]=m.useState(-1),[c,h]=m.useState(!1),[C,q]=m.useState(""),[T,r]=m.useState(!1),[a,o]=m.useState(!1);return e.jsxs(e.Fragment,{children:[e.jsxs(Pe,{defaultExpanded:!1,disableGutters:!0,children:[e.jsx(Ee,{expandIcon:e.jsx(ue,{}),children:"Relationships"}),e.jsxs(Be,{children:[e.jsx(l,{sx:{marginBottom:"30px"},children:x?e.jsx(e.Fragment,{children:!f&&e.jsx(He,{appId:i,embedded:!1,enableWizard:p,children:e.jsx(Le,{appId:i,embedded:!1,metaData:t,isUpdating:f,enableWizard:p,initialRelationships:s,initialTitle:""})})}):e.jsx(F,{variant:"contained",fullWidth:!0,disabled:!0,startIcon:e.jsx(he,{}),endIcon:e.jsx(ee,{}),onClick:()=>{},children:"Start relationship wizard"})}),!1,e.jsx(e.Fragment,{children:!1}),e.jsxs(N,{component:"div",sx:{marginTop:"30px"},children:[e.jsxs(A,{sx:{textDecoration:"none",cursor:"pointer",display:"inline-flex","& svg":{fontSize:"1rem",marginRight:"2px"}},onClick:()=>r(!T),children:[e.jsx(V,{}),"How to use the relationship wizard?"]}),T&&e.jsxs(l,{sx:{marginTop:"20px",marginBottom:"30px",display:"grid",gap:"20px"},children:[e.jsx(l,{children:"The following relationship types are supported:"}),e.jsxs("ul",{style:{listStyle:"disc",padding:"0 40px"},children:[e.jsx("li",{children:"one to one relationship (1:1)"}),e.jsx("li",{children:"one to many relationship (1:m)"}),e.jsx("li",{children:"many to many relationship (m:m)"})]}),e.jsxs(l,{children:["To add a relationship, click the ",e.jsx("strong",{children:"start relationship wizard"})," button and follow the instructions. Relationships are added to the bottom of the form. Use the display type to define how relationships are displayed (possible values are: ",e.jsx("strong",{children:"Accordion"}),", ",e.jsx("strong",{children:"Tabs"})," or ",e.jsx("strong",{children:"Titles"}),")."]})]})]}),e.jsxs(N,{component:"div",children:[e.jsxs(A,{sx:{textDecoration:"none",cursor:"pointer",display:"inline-flex","& svg":{fontSize:"1rem",marginRight:"2px"}},onClick:()=>o(!a),children:[e.jsx(V,{}),"How to create a multi level master detail form?"]}),a&&e.jsx(l,{sx:{marginTop:"20px",display:"grid",gap:"20px"},children:e.jsxs(l,{children:["Add a ",e.jsx("strong",{children:"relationship"})," to the ",e.jsx("strong",{children:"master table"})," using the ",e.jsx("strong",{children:"relationship wizard"}),". Open the ",e.jsx("strong",{children:"detail table"}),". Open the ",e.jsx("strong",{children:"Table Builder"})," from the ",e.jsx("strong",{children:"detail table"})," or navigate to the ",e.jsx("strong",{children:"detail form"})," to open the ",e.jsx("strong",{children:"Form Builder"}),". The buttons to access the ",e.jsx("strong",{children:"Table Builders"})," and ",e.jsx("strong",{children:"Form Builders"})," are available in the footer. Open the ",e.jsx("strong",{children:"Relationships"})," section and start the ",e.jsx("strong",{children:"relationship wizard"}),"."]})})]}),e.jsx(Ie,{})]})]}),c&&e.jsx(ze,{title:"Delete Relationship?",message:"Are you sure you want to delete this relationship? This action cannot be undone!",open:c,setOpen:h,onConfirm:()=>{}})]})};export{Ue as D,wt as S,re as U};
