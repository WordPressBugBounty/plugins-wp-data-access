import{j as N}from"./cm-1.0.37-CEr77VZi.js";import{r as a}from"./redux-1.0.37-C4JSQ-MG.js";import{l as r,b as V,c2 as U}from"./lib-1.0.37-Czwr-8r3.js";import{l as O}from"./ActionsDml-1.0.37-kzr7tHjI.js";import{u as X,a as Y}from"./hooks-1.0.37-DW0_oiBB.js";import{u as Z}from"./AppTheme-1.0.37-DOXnENpA.js";import{c as $}from"./tab-1.0.37-_GJbvkmQ.js";import{i as D}from"./index-1.0.37-9tYvXmzh.js";import{F as M}from"./FormHelperText-1.0.37-ylnS0Km6.js";import{A as R}from"./Autocomplete-1.0.37-5_yZAyWV.js";import{T as I}from"./TextField-1.0.37-CCe4G0U1.js";import"./vendor-1.0.37-CN03Eozo.js";import"./loglevel-1.0.37-BZ7XahX3.js";import"./lodash-1.0.37-Dx3wKrSf.js";import"./moment-1.0.37-C5S46NFB.js";import"./RestApi-1.0.37-CcjslynE.js";import"./index-1.0.37-D4zhytA1.js";import"./Typography-1.0.37-DjtXWQnP.js";import"./getThemeProps-1.0.37-BGc0S4YC.js";import"./useEnhancedEffect-1.0.37-UwysO4qr.js";import"./utils-1.0.37-iop7lDec.js";import"./useFormControl-1.0.37-BcUwa2qz.js";import"./Select-1.0.37-B5ZKqjeL.js";import"./Menu-1.0.37-Ca8DeoO3.js";import"./ThemeProvider-1.0.37-Cyf1xy26.js";import"./index-1.0.37-B60ShF2d.js";import"./iconBase-1.0.37-DRohixw7.js";import"./notistack-1.0.37-CEqipxDI.js";import"./useControlled-1.0.37-DyimEgDk.js";import"./createSvgIcon-1.0.37-DXsAQOmB.js";import"./Close-1.0.37-Yr1E1-6A.js";import"./Popper-1.0.37-CSsNCozr.js";import"./FormLabel-1.0.37-BQP5Nx_Z.js";const w=(t,e)=>{const m=X(f=>f.lookups[t]!==void 0?f.lookups[t][e]:void 0);return r.debug("lookup",m),m},qo=({value:t,columnState:e,columnMetaData:m,setValue:f,saveChanges:T,appId:p,currentRow:c,storeRow:h,row:P})=>{var L,j;r.debug(t,e,m,p,c,h,P);const F=Y(),v=Z(p),[q,W]=a.useState(!1),[x,_]=a.useState(t);a.useEffect(()=>{r.debug("useEffect",e.columnName,x,t,c[e.columnName]),h!==void 0&&h[e.columnName]!==void 0&&x!==t&&(T(),_(t))},[t]);const k=w(p,e.columnName),[g,b]=a.useState([]);r.debug("lov",g);const[d,H]=a.useState(Array.isArray((L=e.lookup)==null?void 0:L.dynamicConditions)?(j=e.lookup)==null?void 0:j.dynamicConditions.map(o=>({columnName:o.lookupColumnName,columnValue:c[o.tableColumnName]??""})):[]);r.debug("conditions",d),a.useEffect(()=>{if(k!==void 0)if(Object.keys(k).length>0){const o=[];for(const n in k)o.push({key:n,value:k[n]});b(o)}else d.length===0&&z();else b([])},[k]);const z=()=>{if(!q&&g.length===0){W(!0);const o=e.lookup;if(o!==void 0){const n=v.isRelationSelectionTable===!0?V.relationTablePrefix+e.columnName:e.columnName;O(p,"table",n,o.key,o.value,{},{},l=>{r.debug(l.data);const s={};for(let i=0;i<l.data.length;i++)if(!o.value.includes(","))s[l.data[i].key]=l.data[i].value;else{const u=o.value.split(",");s[l.data[i].key]=u.map(y=>l.data[i][y])}r.debug(s),F(U({appId:p,columnName:e.columnName,lookup:s}))},l=>{r.error(l)})}}else r.error("Error loading lookup - please check server response")};a.useEffect(()=>{var o,n;if(Object.keys(d).length>0&&d.length>0){const l=Array.isArray((o=e.lookup)==null?void 0:o.dynamicConditions)?(n=e.lookup)==null?void 0:n.dynamicConditions.map(i=>({columnName:i.lookupColumnName,columnValue:c[i.tableColumnName]??""})):[];r.debug("reload lookup?",d,l);const s={};if(l.length>0&&l.map(i=>{s[i.columnName]=i.columnValue}),D(d,l))r.debug("reloading dynamic lookup",e.columnName,l,s),A(s);else{const i={};l.length>0&&l.map(u=>{i[u.columnName]=u.columnValue}),H(l),l.filter(u=>u.columnValue===""||u.columnValue===null).length===0?A(i):b([])}}},[c]);const A=(o={})=>{const n=e.lookup;if(n!==void 0){const l=v.isRelationSelectionTable===!0?V.relationTablePrefix+e.columnName:e.columnName;O(p,"table",l,n.key,n.value,o,{},s=>{var i,u,y;if(r.debug(s.data),!((i=e.lookup)!=null&&i.value.includes(",")))b(s.data);else{const J=(u=e.lookup)==null?void 0:u.value.split(","),E=[];for(let C=0;C<s.data.length;C++){const K=J.map(Q=>s.data[C][Q]).join(((y=e.lookup)==null?void 0:y.delimiter)??"");E.push({key:s.data[C].key,value:K})}b(E)}},s=>{r.error(s)})}},B=o=>{var n;return Array.isArray(o.value)?o.value.join(((n=e.lookup)==null?void 0:n.delimiter)??""):o.value},G=a.useMemo(()=>g.filter(o=>o.key===t)[0]??null,[g,t]);return N.jsx("div",{onClick:o=>{o.stopPropagation()},children:N.jsx(M,{fullWidth:!0,onClick:o=>{o.stopPropagation()},children:N.jsx(R,{className:"pp-inline-editing",multiple:!1,fullWidth:!0,autoHighlight:!0,disableClearable:m.is_nullable==="NO",options:g,getOptionLabel:o=>B(o),value:G,onChange:(o,n)=>{f(n!==null?n.key:null),o.stopPropagation()},renderInput:o=>N.jsx(I,{label:m.formLabel,required:m.is_nullable==="NO",...o,sx:$(e)})})})})};export{qo as default};
