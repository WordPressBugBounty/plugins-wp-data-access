import{l as t,ap as de,E as he,A as F,af as g,r as j,aq as Y,ar as Se,as as Ne,at as _e,b as Ae,ae as G,au as L,ag as Pe,ah as Ce,av as Je,F as xe,g as Te,aw as De,S as we,ax as Fe,ay as Ie,az as Re,aA as Ue,aB as Be,ai as Ee}from"./lib-1.0.40-CJM-IO_o.js";import{a as Me}from"./hooks-1.0.40-DoKijNI1.js";const Ve=(c,I)=>({app_id:c,cnt_id:I}),qe=(c,I)=>({dbs:c,tbl:I}),Le=(c,I)=>{t.debug(c,I);const T=Me(),Oe=(i,u,e,_)=>{var o,A,D,a,N,O,y,R,v,q,U,B,E,M,s,n,h,z,W,H,K,Q,X,Z,$,ee,le,se,te,re,ne,ue,oe,me,ce,ie,pe,ge,be,fe,ae;t.debug(e);const S=(o=e.access.insert)==null?void 0:o.some(r=>r.toUpperCase()==="POST"),d=(A=e.access.update)==null?void 0:A.some(r=>r.toUpperCase()==="POST"),b=(D=e.access.delete)==null?void 0:D.some(r=>r.toUpperCase()==="POST");e.src=qe(i,u),e.privs={select:!0,insert:S,update:d,delete:b};let l={};((O=(N=(a=e==null?void 0:e.settings)==null?void 0:a.ui)==null?void 0:N.global)==null?void 0:O.table)!==!1?(l=g({},j,(v=(R=(y=e==null?void 0:e.settings)==null?void 0:y.ui)==null?void 0:R.global)==null?void 0:v.table),(s=(M=(E=(B=(U=(q=e==null?void 0:e.settings)==null?void 0:q.ui)==null?void 0:U.global)==null?void 0:B.table)==null?void 0:E.table)==null?void 0:M.pagination)!=null&&s.rowsPerPage&&(l.table.pagination.rowsPerPage=[...e.settings.ui.global.table.table.pagination.rowsPerPage]),(H=(W=(z=(h=(n=e==null?void 0:e.settings)==null?void 0:n.ui)==null?void 0:h.global)==null?void 0:z.table)==null?void 0:W.table)!=null&&H.defaultOrderBy&&(l.table.defaultOrderBy=[...e.settings.ui.global.table.table.defaultOrderBy])):l=g({},j,{table:{transactions:{insert:S,update:d,delete:b},bulkActions:{pdf:!1,csv:!0,json:!0,excel:!1,xml:!0,sql:!0,delete:(K=e==null?void 0:e.privs)==null?void 0:K.delete}}});const w=[];for(let r=0;r<e.columns.length;r++)w[r]=Y(e.columns[r].column_name,e.table_labels[e.columns[r].column_name]??e.columns[r].column_name);const f=[];if(Array.isArray(l.columns)&&l.columns.length>0){for(let r=0;r<l.columns.length;r++){const V=Te(e,l.columns[r].columnName);V!==void 0?f.push(g({},w[V],l.columns[r])):f.push(g({},Y(e.columns[r].column_name),l.columns[r]))}l.columns=f}else l.columns=w;l.table.largeTableSupport.saved===Ne.AUTO?l.table.largeTableSupport.actual=_e(e):l.table.largeTableSupport.actual=l.table.largeTableSupport.saved,t.debug(l);let m={...G};((Z=(X=(Q=e==null?void 0:e.settings)==null?void 0:Q.ui)==null?void 0:X.global)==null?void 0:Z.form)!==!1&&(m=g({},G,(le=(ee=($=e==null?void 0:e.settings)==null?void 0:$.ui)==null?void 0:ee.global)==null?void 0:le.form));const P=[];for(let r=0;r<e.columns.length;r++)P[r]=L(e.columns[r].column_name,e.form_labels[e.columns[r].column_name]??e.columns[r].column_name);const C=[];if(Array.isArray(m.columns)&&m.columns.length>0){for(let r=0;r<m.columns.length;r++){const V=Te(e,m.columns[r].columnName);V!==void 0?C.push(g({},P[V],m.columns[r])):C.push(g({},L(m.columns[r].column_name),m.columns[r]))}m.columns=C}else m.columns=P;const J=De.getSelectors().selectSelected(we.getState().explorer);t.debug("selected",J),J&&J[i]==="wp"&&((te=(se=e==null?void 0:e.settings)==null?void 0:se.wp)==null?void 0:te.tables)!==void 0&&Array.isArray(e.settings.wp.tables)&&e.settings.wp.tables.includes(u)&&(m.form={...Fe},m.form.preserveSpacesOnUpdate=!0);let x={};if(((ue=(ne=(re=e==null?void 0:e.settings)==null?void 0:re.ui)==null?void 0:ne.global)==null?void 0:ue.theme)!==void 0&&((ce=(me=(oe=e==null?void 0:e.settings)==null?void 0:oe.ui)==null?void 0:me.global)==null?void 0:ce.theme)!==null&&((ge=(pe=(ie=e==null?void 0:e.settings)==null?void 0:ie.ui)==null?void 0:pe.global)==null?void 0:ge.theme)!=="")try{x=JSON.parse((ae=(fe=(be=e==null?void 0:e.settings)==null?void 0:be.ui)==null?void 0:fe.global)==null?void 0:ae.theme)}catch(r){t.error("Invalid JSON - theme settings"),t.error(r)}x===!1&&(x={});const p=g({},Ie,x);return k(e,l,m,p,_===!0)},ye=(i,u,e,_,S,d)=>{var U,B,E,M;t.debug(i,u,e,_,S);const b=u.app.app[0];t.debug(b);const l=u.app.container[0];t.debug(l);let w={};try{w=JSON.parse(b.app_settings)}catch(s){t.error("Invalid JSON - app settings"),t.error(s)}t.debug(w);let f={};try{f=JSON.parse(l.cnt_cls)}catch(s){t.error("Invalid JSON - app columns"),t.error(s)}t.debug(f);const m=b.app_type,P=Number(m)===F.DATAENTRY||Number(m)===F.REGISTRATION,C=Number(m)===F.DATAENTRY||Number(m)===F.REGISTRATION||Number(m)===F.UPDATEFORM,J=Number(m)===F.DATAENTRY;t.debug(P,C,J),u.src=Ve(i,l.cnt_id),u.privs={select:!0,insert:P,update:C,delete:J};const x=g({},j,{table:{transactions:{insert:P,update:C,delete:J},bulkActions:{pdf:!1,csv:!0,json:!0,excel:!1,xml:!0,sql:!0,delete:(U=u==null?void 0:u.privs)==null?void 0:U.delete}}});t.debug(x);let p={};if(l.cnt_table!==void 0&&l.cnt_table!==null&&l.cnt_table!=="")try{p=JSON.parse(l.cnt_table)}catch(s){t.error("Invalid JSON - table settings"),t.error(s)}t.debug(p);const o=g({},x,p);(E=(B=p==null?void 0:p.table)==null?void 0:B.pagination)!=null&&E.rowsPerPage&&(o.table.pagination.rowsPerPage=[...p.table.pagination.rowsPerPage]),(M=p==null?void 0:p.table)!=null&&M.defaultOrderBy&&(o.table.defaultOrderBy=[...p.table.defaultOrderBy]),t.debug(o);const A=[];for(let s=0;s<f.length;s++)f[s].isSelected===!0&&A.push(Y(f[s].columnName,u.table_labels[f[s].columnName]??f[s].columnName,!0));if(t.debug(A),Array.isArray(o.columns)&&o.columns.length>0){const s=[];for(let n=0;n<o.columns.length;n++)if(o.columns[n].computedField!==void 0)s.push(g({},Y(o.columns[n].columnName),o.columns[n]));else{const h=Se(A,o.columns[n].columnName);h!==void 0&&s.push(g({},A[h],o.columns[n]))}A.map(n=>{s.filter(h=>h.columnName===n.columnName).length===0&&s.push(n)}),t.debug(s),o.columns=s}else o.columns=A;if(o.table.largeTableSupport.saved===Ne.AUTO?o.table.largeTableSupport.actual=_e(u):o.table.largeTableSupport.actual=o.table.largeTableSupport.saved,(u==null?void 0:u.isRelationSelectionTable)===!0&&(p==null?void 0:p.columns)!==void 0&&Array.isArray(p.columns)){const s=[];p.columns.map(n=>{if(n.columnName.startsWith(Ae.relationTablePrefix)){const h={...n};h.columnName=n.columnName.substring(Ae.relationTablePrefix.length),s.push(h)}}),o.columns=[...s]}t.debug(o);let D={};if((l==null?void 0:l.cnt_form)!==void 0&&(l==null?void 0:l.cnt_form)!==null&&(l==null?void 0:l.cnt_form)!==""||u.useRform===!0&&(l==null?void 0:l.cnt_rform)!==void 0&&(l==null?void 0:l.cnt_rform)!==null&&(l==null?void 0:l.cnt_rform)!=="")try{u.useRform===!0?D=JSON.parse(l.cnt_rform):D=JSON.parse(l.cnt_form)}catch(s){t.error("Invalid JSON - form settings"),t.error(s)}t.debug(D);const a=g({},G,D);t.debug(a);const N=[];for(let s=0;s<f.length;s++)f[s].isSelected===!0&&N.push(L(f[s].columnName,u.form_labels[f[s].columnName]??f[s].columnName,!0));if(t.debug(N),Array.isArray(a.columns)&&a.columns.length>0){const s=[];for(let n=0;n<a.columns.length;n++)if(a.columns[n].computedField!==void 0)s.push(g({},N[n],a.columns[n]));else{const h=Se(N,a.columns[n].columnName);h!==void 0&&s.push(g({},N[h],a.columns[n]))}N.map(n=>{s.filter(h=>h.columnName===n.columnName).length===0&&s.push(n)}),a.columns=s}else a.columns=N;t.debug(a);let O={};if((b==null?void 0:b.app_theme)!==void 0&&(b==null?void 0:b.app_theme)!==null&&(b==null?void 0:b.app_theme)!=="")try{O=JSON.parse(b.app_theme)}catch(s){t.error("Invalid JSON - theme settings"),t.error(s)}O===!1&&(O={}),t.debug(O),S!==void 0&&(u.appRootId=S);let y={};if((l==null?void 0:l.cnt_chart)!==void 0&&(l==null?void 0:l.cnt_chart)!==null&&(l==null?void 0:l.cnt_chart)!=="")try{y=JSON.parse(l.cnt_chart)}catch(s){t.error("Invalid JSON - chart settings"),t.error(s)}y===!1&&(y={}),t.debug(y);const R=g({},Pe,y);t.debug(R),T(Ce({appId:c,chartState:R}));let v={};if((l==null?void 0:l.cnt_map)!==void 0&&(l==null?void 0:l.cnt_map)!==null&&(l==null?void 0:l.cnt_map)!=="")try{v=JSON.parse(l.cnt_map)}catch(s){t.error("Invalid JSON - chart settings"),t.error(s)}v===!1&&(v={}),t.debug(v);const q=g({},Je,v);return T(xe({appId:c,mapState:q})),k(u,o,a,O,e===!0,d)},ve=(i,u)=>{t.debug(i);const e=i.app.app[0];t.debug(e);let _={};try{_=JSON.parse(e.app_settings)}catch(S){t.error("Invalid JSON - app settings"),t.error(S)}return t.debug(_),T(de({appId:c,apps:i.app.apps,titles:i.app.titles,appSettings:_})),T(he({appId:c,metaData:{...i,isExploring:u??!1}})),!0},k=(i,u,e,_,S,d)=>(t.debug(i),T(he({appId:c,metaData:{...i}})),T(Re({appId:c,tableState:u,tableAccess:{insert:i.privs.insert,update:i.privs.update,delete:i.privs.delete},isView:Ue(i),exploring:S})),T(Be({appId:c,formState:e})),T(Ee({appId:c,themeState:_})),d!==void 0&&d(),!0);return{prepareAdminStore:Oe,prepareAppStore:ye,prepareApp:ve}};var Ye=(c=>(c[c.ADMIN=0]="ADMIN",c[c.APP=1]="APP",c))(Ye||{});export{Ve as D,Ye as S,Le as u};
