import{j as C}from"./cm-1.0.24-lBsX3THK.js";import{r as a}from"./redux-1.0.24-Bx8jJ3ee.js";import{l as r,b as E,bH as U}from"./lib-1.0.24-up-HxGpi.js";import{l as O}from"./ActionsDml-1.0.24-BgEAxcii.js";import{u as X,a as Y}from"./RestApi-1.0.24-BCmVwqnT.js";import{i as Z}from"./index-1.0.24-Ddib3Wz4.js";import{c as $}from"./useTheme-1.0.24-CdGcp-pX.js";import{F as D}from"./FormHelperText-1.0.24-dIoAVumM.js";import{A as M}from"./Autocomplete-1.0.24-C17x-b9y.js";import{T as R}from"./TextField-1.0.24-CX3Aj71c.js";import"./vendor-1.0.24-BmpNFhoq.js";import"./loglevel-1.0.24-BZ7XahX3.js";import"./lodash-1.0.24-CC2RnyUh.js";import"./moment-1.0.24-C5S46NFB.js";import"./index-1.0.24-COcPbr-v.js";import"./Typography-1.0.24-DtpcakL_.js";import"./index-1.0.24-CyelUMLZ.js";import"./iconBase-1.0.24-C7lJg7VQ.js";import"./notistack-1.0.24-EH6RgmCJ.js";import"./useFormControl-1.0.24-BVJe4wXv.js";import"./Close-1.0.24-16O9KsVp.js";import"./createSvgIcon-1.0.24-BKX7HR5-.js";import"./Popper-1.0.24-pV6SBss6.js";import"./ThemeProvider-1.0.24-koXQmW7k.js";import"./useControlled-1.0.24-DnsqB4VW.js";import"./FormLabel-1.0.24-DNrTGbzF.js";import"./Menu-1.0.24-Bmzze4W5.js";const w=(t,e)=>{const m=X(c=>c.lookups[t]!==void 0?c.lookups[t][e]:void 0);return r.debug("lookup",m),m},jo=({value:t,columnState:e,columnMetaData:m,setValue:c,saveChanges:T,appId:p,currentRow:f,storeRow:N,row:P})=>{var L,j;r.debug(t,e,m,p,f,N,P);const F=Y(),h=$(p),[q,H]=a.useState(!1),[x,W]=a.useState(t);a.useEffect(()=>{r.debug("useEffect",e.columnName,x,t,f[e.columnName]),N!==void 0&&N[e.columnName]!==void 0&&x!==t&&(T(),W(t))},[t]);const k=w(p,e.columnName),[g,b]=a.useState([]);r.debug("lov",g);const[d,_]=a.useState(Array.isArray((L=e.lookup)==null?void 0:L.dynamicConditions)?(j=e.lookup)==null?void 0:j.dynamicConditions.map(o=>({columnName:o.lookupColumnName,columnValue:f[o.tableColumnName]??""})):[]);r.debug("conditions",d),a.useEffect(()=>{if(k!==void 0)if(Object.keys(k).length>0){const o=[];for(const s in k)o.push({key:s,value:k[s]});b(o)}else d.length===0&&z();else b([])},[k]);const z=()=>{if(!q&&g.length===0){H(!0);const o=e.lookup;if(o!==void 0){const s=h.isRelationSelectionTable===!0?E.relationTablePrefix+e.columnName:e.columnName;O(p,"table",s,o.key,o.value,{},{},l=>{r.debug(l.data);const n={};for(let i=0;i<l.data.length;i++)if(!o.value.includes(","))n[l.data[i].key]=l.data[i].value;else{const u=o.value.split(",");n[l.data[i].key]=u.map(v=>l.data[i][v])}r.debug(n),F(U({appId:p,columnName:e.columnName,lookup:n}))},l=>{r.error(l)})}}else r.error("Error loading lookup - please check server response")};a.useEffect(()=>{var o,s;if(Object.keys(d).length>0&&d.length>0){const l=Array.isArray((o=e.lookup)==null?void 0:o.dynamicConditions)?(s=e.lookup)==null?void 0:s.dynamicConditions.map(i=>({columnName:i.lookupColumnName,columnValue:f[i.tableColumnName]??""})):[];r.debug("reload lookup?",d,l);const n={};if(l.length>0&&l.map(i=>{n[i.columnName]=i.columnValue}),Z(d,l))r.debug("reloading dynamic lookup",e.columnName,l,n),A(n);else{const i={};l.length>0&&l.map(u=>{i[u.columnName]=u.columnValue}),_(l),l.filter(u=>u.columnValue===""||u.columnValue===null).length===0?A(i):b([])}}},[f]);const A=(o={})=>{const s=e.lookup;if(s!==void 0){const l=h.isRelationSelectionTable===!0?E.relationTablePrefix+e.columnName:e.columnName;O(p,"table",l,s.key,s.value,o,{},n=>{var i,u,v;if(r.debug(n.data),!((i=e.lookup)!=null&&i.value.includes(",")))b(n.data);else{const J=(u=e.lookup)==null?void 0:u.value.split(","),V=[];for(let y=0;y<n.data.length;y++){const K=J.map(Q=>n.data[y][Q]).join(((v=e.lookup)==null?void 0:v.delimiter)??"");V.push({key:n.data[y].key,value:K})}b(V)}},n=>{r.error(n)})}},B=o=>{var s;return Array.isArray(o.value)?o.value.join(((s=e.lookup)==null?void 0:s.delimiter)??""):o.value},G=a.useMemo(()=>g.filter(o=>o.key===t)[0]??null,[g,t]);return C.jsx("div",{onClick:o=>{o.stopPropagation()},children:C.jsx(D,{fullWidth:!0,onClick:o=>{o.stopPropagation()},children:C.jsx(M,{className:"pp-inline-editing",multiple:!1,fullWidth:!0,autoHighlight:!0,disableClearable:m.is_nullable==="NO",options:g,getOptionLabel:o=>B(o),value:G,onChange:(o,s)=>{c(s!==null?s.key:null),o.stopPropagation()},renderInput:o=>C.jsx(R,{label:m.formLabel,required:m.is_nullable==="NO",...o})})})})};export{jo as default};
